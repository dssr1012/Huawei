packer {
  required_plugins {
    huaweicloud = {
      version = ">= 1.0.0"
      source  = "github.com/huaweicloud/huaweicloud"
    }
  }
}

source "huaweicloud-ecs" "artifact" {
  region            = "la-south-2"
  flavor            = "s6.large.4"
  source_image_name = "Huawei Cloud EulerOS 2.0 Standard 64 bit"
  image_name        = "EulerOS-2.5-image-powered-by-Packer"
  image_tags = {
    builder = "packer"
    os      = "EulerOS-2.5-server"
  }

  ssh_username       = "root"
  eip_type           = "5_bgp"
  eip_bandwidth_size = 5
}

build {
  sources = ["source.huaweicloud-ecs.artifact"]

  provisioner "shell" {
    inline = ["yum update -y",
        "yum install patch -y",
        "yum install cvs -y",
        "yum install libxml2-devel -y",
        "wget https://www.php.net/distributions/php-7.3.33.tar.gz",
        "tar -xzf php-7.3.33.tar.gz",
        "cd php-7.3.33",
        "./configure",
        "make",
        "make install",
        "yum install httpd -y",
        "systemctl start httpd",
		"systemctl enable httpd"
        ]
  }

  post-processor "manifest" {
    strip_path = true
    output     = "packer-result.json"
  }
}
